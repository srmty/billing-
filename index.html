<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sun Qwin Enterprises - Billing App</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f7f7f7;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .header {
            background: linear-gradient(to right, #555555, #777777);
            color: white;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header h1 {
            margin: 0;
            font-size: 24px;
        }
        .dashboard {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 20px;
        }
        .panel {
            background-color: white;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            padding: 20px;
            margin-bottom: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, select, textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        textarea {
            height: 80px;
            resize: vertical;
        }
        button {
            background-color: #666666;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        button:hover {
            background-color: #444444;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 15px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        .total-row {
            font-weight: bold;
            background-color: #f9f9f9;
        }
        .actions {
            display: flex;
            margin-top: 20px;
        }
        .item-actions {
            display: flex;
            gap: 5px;
        }
        .item-actions button {
            padding: 5px 10px;
            font-size: 12px;
        }
        .remove-btn {
            background-color: #cc5555;
        }
        .remove-btn:hover {
            background-color: #aa4444;
        }
        .edit-btn {
            background-color: #5555cc;
        }
        .edit-btn:hover {
            background-color: #4444aa;
        }
        .update-btn {
            background-color: #55aa55;
        }
        .update-btn:hover {
            background-color: #448844;
        }
        .cancel-btn {
            background-color: #888888;
        }
        .cancel-btn:hover {
            background-color: #666666;
        }
        .print-preview {
            background-color: white;
            padding: 20px;
            border: 1px solid #ddd;
            margin-top: 20px;
            display: none;
        }
        .bill-header {
            display: flex;
            justify-content: space-between;
            border-bottom: 2px solid #555555;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        .company-info {
            font-size: 14px;
        }
        .company-name {
            font-size: 20px;
            font-weight: bold;
            color: #555555;
        }
        .bill-title {
            text-align: center;
            margin: 20px 0;
            font-size: 18px;
            font-weight: bold;
        }
        .customer-info {
            margin-bottom: 20px;
        }
        .summary {
            display: flex;
            justify-content: flex-end;
            margin-top: 20px;
        }
        .summary-table {
            width: 300px;
        }
        .footer {
            margin-top: 50px;
            text-align: center;
            font-size: 14px;
            color: #777;
        }
        .company-settings {
            margin-top: 10px;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
        .tabs {
            display: flex;
            margin-bottom: 15px;
            border-bottom: 1px solid #ddd;
        }
        .tab {
            padding: 10px 15px;
            background-color: #f5f5f5;
            border: 1px solid #ddd;
            border-bottom: none;
            border-radius: 5px 5px 0 0;
            margin-right: 5px;
            cursor: pointer;
        }
        .tab.active {
            background-color: white;
            border-bottom: 1px solid white;
            margin-bottom: -1px;
        }
        .tax-settings {
            display: flex;
            align-items: center;
            margin-top: 10px;
        }
        .tax-settings label {
            margin-right: 10px;
            display: inline-block;
        }
        .tax-settings input {
            width: 80px;
        }
        .warranty-info {
            border-top: 1px dashed #ddd;
            margin-top: 20px;
            padding-top: 10px;
        }
        /* Additional styling for new color scheme */
        #generate-bill {
            background-color: #4a7c59;
        }
        #generate-bill:hover {
            background-color: #3d6b4c;
        }
        #print-bill {
            background-color: #746c70;
        }
        #print-bill:hover {
            background-color: #635b5f;
        }
        #save-pdf {
            background-color: #7a754e;
        }
        #save-pdf:hover {
            background-color: #68643e;
        }
        #reset-bill {
            background-color: #a15e49;
        }
        #reset-bill:hover {
            background-color: #8d4e3a;
        }
        #save-settings {
            background-color: #4f6d7a;
        }
        #save-settings:hover {
            background-color: #3e5c69;
        }
        #add-item {
            background-color: #666666;
        }
        #add-item:hover {
            background-color: #444444;
        }
        #update-item {
            background-color: #55aa55;
            display: none;
        }
        #update-item:hover {
            background-color: #448844;
        }
        #cancel-edit {
            background-color: #888888;
            display: none;
        }
        #cancel-edit:hover {
            background-color: #666666;
        }
        /* CSV import related styles */
        .csv-controls {
            margin-bottom: 15px;
            padding: 10px;
            background-color: #f5f5f5;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
        
        #csv-item-select {
            margin-bottom: 10px;
        }
        
        .loading {
            display: inline-block;
            margin-left: 10px;
            color: #555;
        }
        
        .csv-status {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }
/* Updated print styles to center the invoice on the page */
@media print {
    body * {
        visibility: hidden;
    }
    .print-preview, .print-preview * {
        visibility: visible;
    }
    .print-preview {
        display: block !important;
        position: absolute;
        top: 0;
        left: 0;
        right: 0; /* Add right: 0 to help with centering */
        width: 90%; /* Reduce width to prevent right side cutoff */
        max-width: 800px; /* Limit maximum width */
        margin: 0 auto !important; /* Center the invoice */
        padding: 15px 25px 15px 15px; /* Add more padding on the right side */
        
        /* Enhanced centering technique */
        transform: translateX(0); /* Reset any transforms */
        left: 50%; /* Position from center of page */
        transform: translateX(-50%); /* Pull back by half width to center */
    }
    
    /* Adjust table sizing for print */
    #bill-items {
        width: 95%;
        table-layout: fixed;
        font-size: 0.9em; /* Slightly reduce font size */
        margin: 0 auto; /* Center the table within its container */
    }
    
    /* Make header more compact */
    .bill-header {
        margin-bottom: 10px;
        text-align: center; /* Center header content */
    }
    
    /* Optimize column widths */
    #bill-items th:nth-child(1), #bill-items td:nth-child(1) { width: 5%; } /* S.No */
    #bill-items th:nth-child(2), #bill-items td:nth-child(2) { width: 25%; } /* Item Description */
    #bill-items th:nth-child(3), #bill-items td:nth-child(3) { width: 15%; } /* Serial/Model */
    #bill-items th:nth-child(4), #bill-items td:nth-child(4) { width: 10%; } /* Warranty */
    #bill-items th:nth-child(5), #bill-items td:nth-child(5) { width: 8%; } /* Qty */
    #bill-items th:nth-child(6), #bill-items td:nth-child(6) { width: 12%; } /* Unit Price */
    #bill-items th:nth-child(7), #bill-items td:nth-child(7) { width: 10%; } /* Tax */
    #bill-items th:nth-child(8), #bill-items td:nth-child(8) { width: 15%; } /* Amount */
    
    /* Ensure text doesn't overflow cells */
    #bill-items td {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: normal;
        word-wrap: break-word;
    }
    
    /* Company and customer info containers */
    .company-info, .customer-info {
        text-align: center; /* Center these sections */
    }
    
    /* Add page margin controls */
    @page {
        margin: 0.5cm; /* Consistent margins all around */
    }
}
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Sun Qwin Enterprises - Billing App</h1>
            <div>
                <span id="current-date"></span>
            </div>
        </div>
        
        <div class="dashboard">
            <div>
                <div class="panel">
                    <div class="tabs">
                        <div class="tab active" data-tab="customer">Customer</div>
                        <div class="tab" data-tab="items">Items</div>
                        <div class="tab" data-tab="settings">Settings</div>
                    </div>
                    
                    <div id="customer-tab" class="tab-content">
                        <h2>Customer Information</h2>
                        <div class="form-group">
                            <label for="customer-name">Customer Name</label>
                            <input type="text" id="customer-name" placeholder="Enter customer name">
                        </div>
                        <div class="form-group">
                            <label for="customer-phone">Phone Number</label>
                            <input type="text" id="customer-phone" placeholder="Enter phone number">
                        </div>
                        <div class="form-group">
                            <label for="customer-email">Email</label>
                            <input type="email" id="customer-email" placeholder="Enter email address">
                        </div>
                        <div class="form-group">
                            <label for="customer-address">Address</label>
                            <input type="text" id="customer-address" placeholder="Enter address">
                        </div>
                        <div class="form-group">
                            <label for="bill-number">Bill Number</label>
                            <input type="text" id="bill-number" placeholder="Enter bill number">
                        </div>
                        <div class="form-group">
                            <label for="payment-method">Payment Method</label>
                            <select id="payment-method">
                                <option value="Cash">Cash</option>
                                <option value="Credit Card">Credit Card</option>
                                <option value="Debit Card">Debit Card</option>
                                <option value="Bank Transfer">Bank Transfer</option>
                                <option value="UPI">UPI</option>
                                <option value="Check">Check</option>
                            </select>
                        </div>
                    </div>
                    
                    <div id="items-tab" class="tab-content" style="display: none;">
                        <h2 id="item-form-title">Add Item</h2>
                        
                        <!-- CSV Item Selection -->
                        <div class="csv-controls">
                            <div class="form-group">
                                <label for="csv-item-select">Select from Inventory (test.csv)</label>
                                <select id="csv-item-select">
                                    <option value="">-- Select an item --</option>
                                </select>
                                <span id="csv-loading" class="loading" style="display: none;">Loading...</span>
                            </div>
                            <div id="csv-status" class="csv-status"></div>
                        </div>
                        
                        <div class="form-group">
                            <label for="item-name">Item Name</label>
                            <input type="text" id="item-name" placeholder="Enter item name">
                        </div>
                        <div class="form-group">
                            <label for="item-description">Item Description</label>
                            <textarea id="item-description" placeholder="Enter item description/specifications"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="item-quantity">Quantity</label>
                            <input type="number" id="item-quantity" min="1" value="1">
                        </div>
                        <div class="form-group">
                            <label for="item-price">Price (per unit)</label>
                            <input type="number" id="item-price" min="0" step="0.01" placeholder="Enter price">
                        </div>
                        <div class="form-group">
                            <label for="item-tax">Tax Rate (%)</label>
                            <input type="number" id="item-tax" min="0" max="100" step="0.01" value="0">
                        </div>
                        <div class="form-group">
                            <label for="item-warranty">Warranty (months)</label>
                            <input type="number" id="item-warranty" min="0" value="0">
                        </div>
                        <div class="form-group">
                            <label for="item-serial">Serial Number/Model</label>
                            <input type="text" id="item-serial" placeholder="Enter serial number or model">
                        </div>
                        <button id="add-item">Add Item</button>
                        <button id="update-item">Update Item</button>
                        <button id="cancel-edit">Cancel</button>
                        <input type="hidden" id="edit-item-index" value="-1">
                    </div>
                    
                    <div id="settings-tab" class="tab-content" style="display: none;">
                        <h2>Company Settings</h2>
                        <div class="form-group">
                            <label for="company-name">Company Name</label>
                            <input type="text" id="company-name" value="Sun Qwin Enterprises">
                        </div>
                        <div class="form-group">
                            <label for="company-street">Street Address</label>
                            <input type="text" id="company-street" value="123 Business Street">
                        </div>
                        <div class="form-group">
                            <label for="company-city">City, State, ZIP</label>
                            <input type="text" id="company-city" value="Business District">
                        </div>
                        <div class="form-group">
                            <label for="company-phone">Phone</label>
                            <input type="text" id="company-phone" value="+1 (555) 123-4567">
                        </div>
                        <div class="form-group">
                            <label for="company-email">Email</label>
                            <input type="email" id="company-email" value="contact@sunqwin.com">
                        </div>
                        <div class="form-group">
                            <label for="company-website">Website</label>
                            <input type="text" id="company-website" value="www.sunqwin.com">
                        </div>
                        <div class="form-group">
                            <label for="default-tax">Default Tax Rate (%)</label>
                            <input type="number" id="default-tax" min="0" max="100" step="0.01" value="5">
                        </div>
                        <div class="form-group">
                            <label for="terms-conditions">Terms & Conditions</label>
                            <textarea id="terms-conditions">1. All items have warranty as specified on the invoice.
2. Warranty is void if product is tampered with.
3. Original invoice must be presented for any warranty claims.
4. Returns accepted within 7 days of purchase with original packaging.</textarea>
                        </div>
                        <button id="save-settings">Save Settings</button>
                    </div>
                </div>
            </div>
            
            <div>
                <div class="panel">
                    <h2>Bill Preview</h2>
                    <table id="items-table">
                        <thead>
                            <tr>
                                <th>Item</th>
                                <th>Description</th>
                                <th>Qty</th>
                                <th>Price</th>
                                <th>Tax</th>
                                <th>Total</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="items-body">
                            <!-- Items will be added here dynamically -->
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="4">Subtotal</td>
                                <td id="subtotal-amount">0.00</td>
                                <td colspan="2"></td>
                            </tr>
                            <tr>
                                <td colspan="4">Tax</td>
                                <td id="tax-amount">0.00</td>
                                <td colspan="2"></td>
                            </tr>
                            <tr class="total-row">
                                <td colspan="4">Grand Total</td>
                                <td id="total-amount">0.00</td>
                                <td colspan="2"></td>
                            </tr>
                        </tfoot>
                    </table>
                    
                    <div class="actions">
                        <button id="generate-bill">Generate Bill</button>
                        <button id="print-bill">Print Bill</button>
                        <button id="save-pdf">Save as PDF</button>
                        <button id="reset-bill">Reset</button>
                    </div>
                </div>
                
                <div class="panel print-preview" id="print-area">
                    <div class="bill-header">
                        <div>
                            <div class="company-name" id="bill-company-name">Sun Qwin Enterprises</div>
                            <div class="company-info" id="company-address">
                                123 Business Street, Business District<br>
                                Phone: +1 (555) 123-4567<br>
                                Email: contact@sunqwin.com<br>
                                GST No: 123456789
                            </div>
                        </div>
                        <div>
                            <div>Invoice No: <span id="bill-no"></span></div>
                            <div>Date: <span id="bill-date"></span></div>
                            <div>Payment: <span id="bill-payment"></span></div>
                        </div>
                    </div>
                    
                    <div class="bill-title">INVOICE</div>
                    
                    <div class="customer-info">
                        <div><strong>Customer:</strong> <span id="bill-customer-name"></span></div>
                        <div><strong>Phone:</strong> <span id="bill-customer-phone"></span></div>
                        <div><strong>Email:</strong> <span id="bill-customer-email"></span></div>
                        <div><strong>Address:</strong> <span id="bill-customer-address"></span></div>
                    </div>
                    
                    <table id="bill-items">
                        <thead>
                            <tr>
                                <th>S.No</th>
                                <th>Item Description</th>
                                <th>Serial/Model</th>
                                <th>Warranty</th>
                                <th>Qty</th>
                                <th>Unit Price</th>
                                <th>Tax (%)</th>
                                <th>Amount</th>
                            </tr>
                        </thead>
                        <tbody id="bill-items-body">
                            <!-- Items will be added here dynamically -->
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="6" style="text-align: right;"><strong>Subtotal:</strong></td>
                                <td colspan="2" id="bill-subtotal">0.00</td>
                            </tr>
                            <tr>
                                <td colspan="6" style="text-align: right;"><strong>Tax Amount:</strong></td>
                                <td colspan="2" id="bill-tax">0.00</td>
                            </tr>
                            <tr>
                                <td colspan="6" style="text-align: right;"><strong>Grand Total:</strong></td>
                                <td colspan="2" id="bill-total">0.00</td>
                            </tr>
                        </tfoot>
                    </table>
                    
                    <div class="warranty-info">
                        <h4>Terms and Conditions:</h4>
                        <p id="bill-terms">
                            1. All items have warranty as specified on the invoice.<br>
                            2. Warranty is void if product is tampered with.<br>
                            3. Original invoice must be presented for any warranty claims.<br>
                            4. Returns accepted within 7 days of purchase with original packaging.
                        </p>
                    </div>
                    
                    <div class="footer">
                        Thank you for your business!
                    </div>
                </div>
            </div>
        </div>
    </div>

<script>
    // Initialize items array
let items = [];
let subtotal = 0;
let taxTotal = 0;
let grandTotal = 0;
let editingItemIndex = -1;
let csvItems = []; // Array to store items from CSV

// Display current date
const today = new Date();
const formattedDate = today.toLocaleDateString('en-US', {
    year: 'numeric', 
    month: 'long', 
    day: 'numeric'
});
document.getElementById('current-date').textContent = formattedDate;

// Load CSV data
function loadCSVData() {
    const csvLoading = document.getElementById('csv-loading');
    const csvStatus = document.getElementById('csv-status');
    const csvSelect = document.getElementById('csv-item-select');
    
    csvLoading.style.display = 'inline-block';
    csvStatus.textContent = 'Loading inventory from test.csv...';
    
    // Get CSV from GitHub repo - use raw content
    fetch('https://raw.githubusercontent.com/srmty/billing-/main/test.csv')
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to fetch CSV file');
            }
            return response.text();
        })
        .then(csvText => {
            // Parse CSV data
            const parsedData = parseCSV(csvText);
            
            if (parsedData && parsedData.length > 0) {
                csvItems = parsedData;
                
                // Clear existing options
                while (csvSelect.options.length > 1) {
                    csvSelect.remove(1);
                }
                
                // Add items to dropdown
                parsedData.forEach((item, index) => {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = item.name || item.Name || `Item ${index + 1}`;
                    csvSelect.appendChild(option);
                });
                
                csvStatus.textContent = `Loaded ${parsedData.length} items from inventory`;
            } else {
                csvStatus.textContent = 'No items found in the CSV file';
            }
        })
        .catch(error => {
            console.error('Error loading CSV:', error);
            csvStatus.textContent = 'Error loading inventory: ' + error.message;
        })
        .finally(() => {
            csvLoading.style.display = 'none';
        });
}

// Parse CSV function
function parseCSV(csvText) {
    // Split by lines
    const lines = csvText.split('\n');
    if (lines.length <= 1) return [];
    
    // Get headers
    const headers = lines[0].split(',').map(header => header.trim());
    
    // Parse rows
    const items = [];
    for (let i = 1; i < lines.length; i++) {
        if (!lines[i].trim()) continue; // Skip empty lines
        
        const values = lines[i].split(',').map(value => value.trim());
        const item = {};
        
        // Create object with header keys
        headers.forEach((header, index) => {
            item[header] = values[index] || '';
        });
        
        items.push(item);
    }
    
    return items;
}

// Handle CSV item selection
document.getElementById('csv-item-select').addEventListener('change', function() {
    const selectedIndex = this.value;
    if (!selectedIndex) return; // No selection
    
    const item = csvItems[selectedIndex];
    if (!item) return;
    
    // Populate form fields with CSV data
    document.getElementById('item-name').value = item.name || item.Name || '';
    document.getElementById('item-description').value = item.description || item.Description || '';
    document.getElementById('item-price').value = item.price || item.Price || '';
    
    // Set tax if available, otherwise use default
    if (item.tax || item.Tax) {
        document.getElementById('item-tax').value = item.tax || item.Tax;
    }
    
    // Set warranty if available, otherwise use default
    if (item.warranty || item.Warranty) {
        document.getElementById('item-warranty').value = item.warranty || item.Warranty;
    }
    
    // Set serial/model if available
    if (item.serial || item.Serial || item.model || item.Model) {
        document.getElementById('item-serial').value = item.serial || item.Serial || item.model || item.Model || '';
    }
    
    // Reset the dropdown to the placeholder after selection
    setTimeout(() => {
        this.selectedIndex = 0;
    }, 500);
});

// Tab switching
const tabs = document.querySelectorAll('.tab');
tabs.forEach(tab => {
    tab.addEventListener('click', function() {
        // Remove active class from all tabs
        tabs.forEach(t => t.classList.remove('active'));
        // Add active class to clicked tab
        this.classList.add('active');
        
        // Hide all tab content
        document.querySelectorAll('.tab-content').forEach(content => {
            content.style.display = 'none';
        });
        
        // Show selected tab content
        const tabId = this.getAttribute('data-tab');
        document.getElementById(tabId + '-tab').style.display = 'block';
        
        // If switching to items tab, load CSV data
        if (tabId === 'items') {
            if (csvItems.length === 0) {
                loadCSVData();
            }
        }
    });
});

// Set default tax rate for new items
document.getElementById('default-tax').addEventListener('change', function() {
    document.getElementById('item-tax').value = this.value;
});

// Save settings
document.getElementById('save-settings').addEventListener('click', function() {
    const companyName = document.getElementById('company-name').value;
    const street = document.getElementById('company-street').value;
    const city = document.getElementById('company-city').value;
    const phone = document.getElementById('company-phone').value;
    const email = document.getElementById('company-email').value;
    const website = document.getElementById('company-website').value;
    const terms = document.getElementById('terms-conditions').value;
    
    // Update company info in bill
    document.getElementById('bill-company-name').textContent = companyName;
    document.getElementById('company-address').innerHTML = 
        `${street}, ${city}<br>
        Phone: ${phone}<br>
        Email: ${email}<br>
        Website: ${website}`;
    
    document.getElementById('bill-terms').innerHTML = terms.replace(/\n/g, '<br>');
    
    alert('Settings saved successfully!');
});

// Add item button
document.getElementById('add-item').addEventListener('click', function() {
    const itemName = document.getElementById('item-name').value;
    const itemDesc = document.getElementById('item-description').value;
    const quantity = parseInt(document.getElementById('item-quantity').value);
    const price = parseFloat(document.getElementById('item-price').value);
    const taxRate = parseFloat(document.getElementById('item-tax').value);
    const warranty = parseInt(document.getElementById('item-warranty').value);
    const serialNum = document.getElementById('item-serial').value;
    
    if (!itemName || isNaN(quantity) || isNaN(price)) {
        alert('Please fill in all required item details (name, quantity, price).');
        return;
    }
    
    const itemTotal = quantity * price;
    const itemTaxAmount = itemTotal * (taxRate / 100);
    const itemTotalWithTax = itemTotal + itemTaxAmount;
    
    // Add to items array
    items.push({
        name: itemName,
        description: itemDesc,
        quantity: quantity,
        price: price,
        taxRate: taxRate,
        taxAmount: itemTaxAmount,
        total: itemTotalWithTax,
        warranty: warranty,
        serialNum: serialNum
    });
    
    // Update the table
    updateItemsTable();
    
    // Clear item inputs
    clearItemForm();
    
    // Switch back to customer tab
    tabs[0].click();
});

// Update item button (for editing)
document.getElementById('update-item').addEventListener('click', function() {
    const itemName = document.getElementById('item-name').value;
    const itemDesc = document.getElementById('item-description').value;
    const quantity = parseInt(document.getElementById('item-quantity').value);
    const price = parseFloat(document.getElementById('item-price').value);
    const taxRate = parseFloat(document.getElementById('item-tax').value);
    const warranty = parseInt(document.getElementById('item-warranty').value);
    const serialNum = document.getElementById('item-serial').value;
    const editIndex = parseInt(document.getElementById('edit-item-index').value);
    
    if (!itemName || isNaN(quantity) || isNaN(price)) {
        alert('Please fill in all required item details (name, quantity, price).');
        return;
    }
    
    if (editIndex < 0 || editIndex >= items.length) {
        alert('Invalid item index.');
        return;
    }
    
    const itemTotal = quantity * price;
    const itemTaxAmount = itemTotal * (taxRate / 100);
    const itemTotalWithTax = itemTotal + itemTaxAmount;
    
    // Update the item in the array
    items[editIndex] = {
        name: itemName,
        description: itemDesc,
        quantity: quantity,
        price: price,
        taxRate: taxRate,
        taxAmount: itemTaxAmount,
        total: itemTotalWithTax,
        warranty: warranty,
        serialNum: serialNum
    };
    
    // Update the table
    updateItemsTable();
    
    // Clear form and reset to add mode
    clearItemForm();
    toggleItemFormMode('add');
    
    // Switch back to customer tab
    
});

// Cancel edit button
document.getElementById('cancel-edit').addEventListener('click', function() {
    clearItemForm();
    toggleItemFormMode('add');
});
    // Toggle item form between add and edit modes
function toggleItemFormMode(mode) {
    const addButton = document.getElementById('add-item');
    const updateButton = document.getElementById('update-item');
    const cancelButton = document.getElementById('cancel-edit');
    const formTitle = document.getElementById('item-form-title');
    
    if (mode === 'add') {
        addButton.style.display = 'inline-block';
        updateButton.style.display = 'none';
        cancelButton.style.display = 'none';
        formTitle.textContent = 'Add Item';
        document.getElementById('edit-item-index').value = '-1';
    } else if (mode === 'edit') {
        addButton.style.display = 'none';
        updateButton.style.display = 'inline-block';
        cancelButton.style.display = 'inline-block';
        formTitle.textContent = 'Edit Item';
    }
}

// Clear item form inputs
function clearItemForm() {
    document.getElementById('item-name').value = '';
    document.getElementById('item-description').value = '';
    document.getElementById('item-quantity').value = '1';
    document.getElementById('item-price').value = '';
    document.getElementById('item-tax').value = document.getElementById('default-tax').value;
    document.getElementById('item-warranty').value = '0';
    document.getElementById('item-serial').value = '';
}

// Update items table with current items
function updateItemsTable() {
    const itemsBody = document.getElementById('items-body');
    itemsBody.innerHTML = '';
    
    subtotal = 0;
    taxTotal = 0;
    
    items.forEach((item, index) => {
        const row = document.createElement('tr');
        
        // Calculate item subtotal (price * quantity)
        const itemSubtotal = item.price * item.quantity;
        subtotal += itemSubtotal;
        taxTotal += item.taxAmount;
        
        row.innerHTML = `
            <td>${item.name}</td>
            <td>${item.description}</td>
            <td>${item.quantity}</td>
            <td>$${item.price.toFixed(2)}</td>
            <td>${item.taxRate}%</td>
            <td>$${item.total.toFixed(2)}</td>
            <td class="item-actions">
                <button class="edit-btn" data-index="${index}">Edit</button>
                <button class="remove-btn" data-index="${index}">Remove</button>
            </td>
        `;
        
        itemsBody.appendChild(row);
    });
    
    // Update totals
    grandTotal = subtotal + taxTotal;
    document.getElementById('subtotal-amount').textContent = '$' + subtotal.toFixed(2);
    document.getElementById('tax-amount').textContent = '$' + taxTotal.toFixed(2);
    document.getElementById('total-amount').textContent = '$' + grandTotal.toFixed(2);
    
    // Add event listeners to edit and remove buttons
    addActionButtonListeners();
}

// Add event listeners to edit and remove buttons
function addActionButtonListeners() {
    // Edit buttons
    document.querySelectorAll('.edit-btn').forEach(button => {
        button.addEventListener('click', function() {
            const index = parseInt(this.getAttribute('data-index'));
            if (index >= 0 && index < items.length) {
                editItem(index);
            }
        });
    });
    
    // Remove buttons
    document.querySelectorAll('.remove-btn').forEach(button => {
        button.addEventListener('click', function() {
            const index = parseInt(this.getAttribute('data-index'));
            if (index >= 0 && index < items.length) {
                removeItem(index);
            }
        });
    });
}

// Edit item
function editItem(index) {
    if (index < 0 || index >= items.length) return;
    
    const item = items[index];
    
    // Set form values
    document.getElementById('item-name').value = item.name;
    document.getElementById('item-description').value = item.description;
    document.getElementById('item-quantity').value = item.quantity;
    document.getElementById('item-price').value = item.price;
    document.getElementById('item-tax').value = item.taxRate;
    document.getElementById('item-warranty').value = item.warranty;
    document.getElementById('item-serial').value = item.serialNum;
    document.getElementById('edit-item-index').value = index;
    
    // Switch to edit mode
    toggleItemFormMode('edit');
    
    // Switch to items tab
    document.querySelector('.tab[data-tab="items"]').click();
}

// Remove item
function removeItem(index) {
    if (index < 0 || index >= items.length) return;
    
    if (confirm('Are you sure you want to remove this item?')) {
        items.splice(index, 1);
        updateItemsTable();
    }
}

// Generate bill
document.getElementById('generate-bill').addEventListener('click', function() {
    const customerName = document.getElementById('customer-name').value;
    const customerPhone = document.getElementById('customer-phone').value;
    const customerEmail = document.getElementById('customer-email').value;
    const customerAddress = document.getElementById('customer-address').value;
    const billNumber = document.getElementById('bill-number').value;
    const paymentMethod = document.getElementById('payment-method').value;
    
    if (!customerName || !customerPhone) {
        alert('Please enter at least customer name and phone number.');
        return;
    }
    
    if (items.length === 0) {
        alert('Please add at least one item to the bill.');
        return;
    }
    
    // Set bill details
    document.getElementById('bill-customer-name').textContent = customerName;
    document.getElementById('bill-customer-phone').textContent = customerPhone;
    document.getElementById('bill-customer-email').textContent = customerEmail;
    document.getElementById('bill-customer-address').textContent = customerAddress;
    document.getElementById('bill-no').textContent = billNumber;
    document.getElementById('bill-date').textContent = formattedDate;
    document.getElementById('bill-payment').textContent = paymentMethod;
    
    // Generate bill items
    const billItemsBody = document.getElementById('bill-items-body');
    billItemsBody.innerHTML = '';
    
    items.forEach((item, index) => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${index + 1}</td>
            <td>${item.name}<br><small>${item.description}</small></td>
            <td>${item.serialNum}</td>
            <td>${item.warranty > 0 ? item.warranty + ' months' : 'No warranty'}</td>
            <td>${item.quantity}</td>
            <td>$${item.price.toFixed(2)}</td>
            <td>${item.taxRate}%</td>
            <td>$${item.total.toFixed(2)}</td>
        `;
        billItemsBody.appendChild(row);
    });
    
    // Set totals
    document.getElementById('bill-subtotal').textContent = '$' + subtotal.toFixed(2);
    document.getElementById('bill-tax').textContent = '$' + taxTotal.toFixed(2);
    document.getElementById('bill-total').textContent = '$' + grandTotal.toFixed(2);
    
    // Show print preview
    document.getElementById('print-area').style.display = 'block';
    
    // Scroll to print preview
    document.getElementById('print-area').scrollIntoView({behavior: 'smooth'});
});

// Print bill
document.getElementById('print-bill').addEventListener('click', function() {
    if (document.getElementById('print-area').style.display !== 'block') {
        alert('Please generate the bill first.');
        return;
    }
    
    window.print();
});

// Save as PDF
document.getElementById('save-pdf').addEventListener('click', function() {
    if (document.getElementById('print-area').style.display !== 'block') {
        alert('Please generate the bill first.');
        return;
    }
    
    alert('To save as PDF, please use the Print function and select "Save as PDF" as your printer.');
    window.print();
});

// Reset bill
document.getElementById('reset-bill').addEventListener('click', function() {
    if (confirm('Are you sure you want to reset the entire bill? This will clear all customer information and items.')) {
        // Clear customer info
        document.getElementById('customer-name').value = '';
        document.getElementById('customer-phone').value = '';
        document.getElementById('customer-email').value = '';
        document.getElementById('customer-address').value = '';
        document.getElementById('bill-number').value = '';
        document.getElementById('payment-method').selectedIndex = 0;
        
        // Clear items
        items = [];
        updateItemsTable();
        
        // Hide print preview
        document.getElementById('print-area').style.display = 'none';
        
        // Switch to customer tab
        document.querySelector('.tab[data-tab="customer"]').click();
    }
});

// Initialize default tax value
document.getElementById('item-tax').value = document.getElementById('default-tax').value;

// Initialize bill number with current date and random number
document.getElementById('bill-number').value = 'INV-' + 
    today.getFullYear().toString().substr(-2) + 
    (today.getMonth() + 1).toString().padStart(2, '0') + 
    today.getDate().toString().padStart(2, '0') + 
    '-' + Math.floor(Math.random() * 1000).toString().padStart(3, '0');

// Load CSV data on page load (after slight delay to ensure UI is ready)
setTimeout(loadCSVData, 500);
</script>
</body>
</html>
